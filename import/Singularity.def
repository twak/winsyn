Bootstrap: docker
From: nvidia/cudagl:10.1-base-ubuntu18.04
Stage: spython-base

%labels
Author="Or Fleisher <or.fleisher@nytimes.com>"
Title="Blender in Docker"
%post
# Dockerfile autogenerated on 03/11/2022, 10:28:35 by root
# Please do not edit this file directly



# Environment variables
DEBIAN_FRONTEND=noninteractive
LC_ALL=C.UTF-8
LANG=C.UTF-8
PATH="$PATH:/bin/3.3/python/bin/"
BLENDER_PATH="/bin/3.3"
BLENDERPIP="/bin/3.3/python/bin/pip3"
BLENDERPY="/bin/3.3/python/bin/python3.10"
HW="GPU"

# Install dependencies
apt-get update && apt-get install -y \
wget \
libopenexr-dev \
bzip2 \
build-essential \
zlib1g-dev \
libxmu-dev \
libxi-dev \
libxxf86vm-dev \
libfontconfig1 \
libxrender1 \
libgl1-mesa-glx \
xz-utils

# Download and install Blender
wget https://mirror.clarkson.edu/blender/release/Blender3.3/blender-3.3.1-linux-x64.tar.xz \
&& tar -xvf blender-3.3.1-linux-x64.tar.xz --strip-components=1 -C /bin \
&& rm -rf blender-3.3.1-linux-x64.tar.xz \
&& rm -rf blender-3.3.1-linux-x64

# Download the Python source since it is not bundled with Blender
wget https://www.python.org/ftp/python/3.10.2/Python-3.10.2.tgz \
&& tar -xzf Python-3.10.2.tgz \
&& cp -r Python-3.10.2/Include/* $BLENDER_PATH/python/include/python3.10/ \
&& rm -rf Python-3.10.2.tgz \
&& rm -rf Python-3.10.2

# Blender comes with a super outdated version of numpy (which is needed for matplotlib / opencv) so override it with a modern one
rm -rf ${BLENDER_PATH}/python/lib/python3.10/site-packages/numpy

# Must first ensurepip to install Blender pip3 and then new numpy
${BLENDERPY} -m ensurepip && ${BLENDERPIP} install --upgrade pip && ${BLENDERPIP} install numpy

# Set the working directory
cd /
%environment
export DEBIAN_FRONTEND=noninteractive
export LC_ALL=C.UTF-8
export LANG=C.UTF-8
export PATH="$PATH:/bin/3.3/python/bin/"
export BLENDER_PATH="/bin/3.3"
export BLENDERPIP="/bin/3.3/python/bin/pip3"
export BLENDERPY="/bin/3.3/python/bin/python3.10"
export HW="GPU"
%runscript
cd /
exec /bin/bash "$@"
%startscript
cd /
exec /bin/bash "$@"
